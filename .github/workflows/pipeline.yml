name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 'Checkout CODE ðŸ›¬'
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image for QA
        if: github.ref == 'refs/heads/qa'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/grupogamu-website:qa

      - name: Build and push Docker image for Production
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/grupogamu-website:latest

  deploy-prod:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Install tools (jq, uuidgen)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y jq uuid-runtime

      - name: Trigger deploy webhook for PROD server
        env:
          URL:       ${{ secrets.DEPLOY_WEBHOOK_PROD }}
          CF_ID:     ${{ secrets.CF_ACCESS_CLIENT_ID_PROD }}
          CF_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET_PROD }}
          HMAC:      ${{ secrets.DEPLOY_HMAC_PROD }}
        run: |
          set -euo pipefail

          echo "::group::Sanity env"
          echo "URL=${URL}"
          echo "CF_ID len: ${#CF_ID}"
          echo "CF_SECRET len: ${#CF_SECRET}"
          echo "::endgroup::"

          case "$URL" in
            */hook) ;; 
            *) echo "ERROR: DEPLOY_WEBHOOK_PROD debe terminar en /hook (actual: $URL)"; exit 1;;
          esac
          BASE="${URL%/hook}"

          retry() { n=0; until "$@" || [ $n -ge 8 ]; do n=$((n+1)); sleep $((2**n)); done; }

          echo "::group::Preflight /healthz"
          retry curl -i -sS -X GET "${BASE}/healthz" \
            -H "CF-Access-Client-Id: ${CF_ID}" \
            -H "CF-Access-Client-Secret: ${CF_SECRET}" || true
          echo "::endgroup::"

          TS=$(date +%s)
          NONCE=$(uuidgen | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${{ github.repository_owner }}/grupogamu-website"
          BODY=$(jq -cn --arg service "grupogamu-website" --arg tag "latest" --arg image "$IMAGE" --arg ts "$TS" --arg nonce "$NONCE" \
            '{service:$service, tag:$tag, image:$image, ts:($ts|tonumber), nonce:$nonce}')

          SIG_HEX=$(printf "%s" "$BODY" | openssl dgst -sha256 -hmac "$HMAC" | awk '{print $2}')
          SIG="sha256=${SIG_HEX}"

          echo "::group::Payload y firma"
          echo "BODY: $BODY"
          echo "SIG:  $SIG"
          echo "::endgroup::"

          echo "::group::POST /hook to PROD"
          HTTP_CODE=$(curl -sS -D /tmp/headers.txt -o /tmp/resp.txt -w "%{http_code}" -X POST "$URL" \
            -H "CF-Access-Client-Id: $CF_ID" \
            -H "CF-Access-Client-Secret: $CF_SECRET" \
            -H "X-Hub-Signature-256: $SIG" \
            -H "Content-Type: application/json" \
            --data "$BODY")
          echo "HTTP_CODE=$HTTP_CODE"
          echo "----- response headers -----"
          sed 's/CF-Authorization:.*/CF-Authorization:[redacted]/g' /tmp/headers.txt || true
          echo "----- body -----"
          cat /tmp/resp.txt || true
          echo "----------------------------"
          echo "::endgroup::"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Fallo el deploy a PROD. HTTP $HTTP_CODE"
            exit 1
          fi
